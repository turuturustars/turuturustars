name: SMS Reminders

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: sms-reminders
  cancel-in-progress: false

jobs:
  send-sms-reminders:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger sms-reminders edge function
        env:
          SMS_REMINDERS_URL: https://mkcgkfzltohxagqvsbqk.supabase.co/functions/v1/sms-reminders
          SMS_REMINDERS_JOB_SECRET: ${{ secrets.SMS_REMINDERS_JOB_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${SMS_REMINDERS_JOB_SECRET}" ]; then
            echo "SMS_REMINDERS_JOB_SECRET is not configured; skipping run to avoid failure spam."
            exit 0
          fi

          curl -sS --fail-with-body \
            -X POST "${SMS_REMINDERS_URL}" \
            -H "Content-Type: application/json" \
            -H "x-sms-job-secret: ${SMS_REMINDERS_JOB_SECRET}" \
            -d '{"limit": 100}'
